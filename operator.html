<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Operator Dashboard - ERIS</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Keep all existing styles from original operator.html */
        .dashboard-container {
            min-height: 100vh;
            padding: 2rem;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            color: #93c5fd;
            margin-bottom: 0.5rem;
        }
        
        .dashboard-subtitle {
            color: #cbd5e1;
            font-size: 1.1rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .card-title {
            font-size: 1.5rem;
            color: #e2e8f0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Patient Search Styles */
        .patient-search-section {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 1rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 60, 114, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 0.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .search-result-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .patient-name-result {
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .patient-details-result {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .call-history-badge {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        
        /* Selected Patient Display */
        .selected-patient-panel {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .selected-patient-name {
            color: #10b981;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .selected-patient-info {
            color: #e2e8f0;
            font-size: 0.95rem;
        }
        
        /* Patient Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            color: #e2e8f0;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* EMT List Styles */
        .emt-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .emt-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .emt-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .emt-item.available {
            border-left: 4px solid #10b981;
        }
        
        .emt-item.busy {
            border-left: 4px solid #ef4444;
            opacity: 0.6;
        }
        
        .emt-info {
            flex: 1;
        }
        
        .emt-name {
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .emt-unit {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .emt-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .emt-status.available {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .emt-status.busy {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .btn-submit {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Call History */
        .call-history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .call-history-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid #3b82f6;
        }
        
        .call-time {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .call-description {
            color: #e2e8f0;
            margin-bottom: 0.5rem;
        }
        
        .call-location {
            color: #cbd5e1;
            font-size: 0.9rem;
        }
        
        /* Success Notification */
        .success-notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .success-notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .back-button {
            position: absolute;
            top: 2rem;
            left: 2rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #93c5fd;
        }
        
        .stat-label {
            color: #cbd5e1;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
    </style>
<script>
window.storage = window.storage || {
  get: async function(k){ return { value: localStorage.getItem(k) }; },
  set: async function(k,v){ localStorage.setItem(k,v); }
};
</script>
</head>
<body>
    <a href="index.html" class="back-button">← Back to Home</a>
    
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Call Operator Dashboard</h1>
            <p class="dashboard-subtitle">Manage emergency calls and dispatch resources</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCalls">0</div>
                <div class="stat-label">Total Calls Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeCalls">0</div>
                <div class="stat-label">Active Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgResponse">0</div>
                <div class="stat-label">Avg Response (min)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableEMTs">0</div>
                <div class="stat-label">Available EMTs</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <!-- Emergency Call Entry Form -->
            <div class="dashboard-card">
                <h2 class="card-title">📞 New Emergency Call</h2>
                
                <!-- Patient Search -->
                <div class="patient-search-section">
                    <label style="color: #e2e8f0; font-weight: 500; margin-bottom: 0.5rem; display: block;">
                        Search Existing Patient
                    </label>
                    <input 
                        type="text" 
                        id="patientSearch" 
                        class="search-input" 
                        placeholder="Search by name, phone, or patient ID..."
                        autocomplete="off"
                    >
                    <div id="searchResults" class="search-results" style="display: none;"></div>
                </div>
                
                <!-- Selected Patient Display -->
                <div id="selectedPatientPanel" class="selected-patient-panel" style="display: none;">
                    <div class="selected-patient-name" id="selectedPatientName"></div>
                    <div class="selected-patient-info" id="selectedPatientDetails"></div>
                    <button class="btn btn-primary" style="margin-top: 0.5rem;" onclick="clearPatientSelection()">
                        Clear Selection
                    </button>
                </div>
                
                <!-- Patient Information Form -->
                <form id="emergencyCallForm">
                    <h3 style="color: #93c5fd; margin-bottom: 1rem;">Patient Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name *</label>
                            <input type="text" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name *</label>
                            <input type="text" id="lastName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="phoneNumber">Phone Number *</label>
                            <input type="tel" id="phoneNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="dateOfBirth">Date of Birth</label>
                            <input type="date" id="dateOfBirth">
                        </div>
                    </div>
                    
                    <h3 style="color: #93c5fd; margin: 1.5rem 0 1rem;">Incident Details</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="callTime">Call Time *</label>
                            <input type="datetime-local" id="callTime" required>
                        </div>
                        <div class="form-group">
                            <label for="priority">Priority *</label>
                            <select id="priority" required>
                                <option value="">Select Priority</option>
                                <option value="Critical">Critical</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="address">Address *</label>
                            <input type="text" id="address" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City *</label>
                            <input type="text" id="city" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State *</label>
                            <input type="text" id="state" required>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="incidentDescription">Incident Description *</label>
                        <textarea id="incidentDescription" rows="4" required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-submit">
                        Submit Emergency Call
                    </button>
                </form>
            </div>
            
            <!-- Available EMTs -->
            <div class="dashboard-card">
                <h2 class="card-title">🚑 Available EMT Units</h2>
                <div id="emtList" class="emt-list"></div>
            </div>
            
            <!-- Patient Call History -->
            <div class="dashboard-card">
                <h2 class="card-title">📋 Patient Call History</h2>
                <div id="patientCallHistory" class="call-history-list">
                    <p style="color: #94a3b8; text-align: center; padding: 2rem;">
                        Select a patient to view call history
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let patients = [];
        let calls = [];
        let emts = [];
        let selectedPatient = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await loadData();
            setupEventListeners();
            updateStats();
            renderEMTList();
            
            // Set default call time
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('callTime').value = localDateTime;
        });
        
        // Load data from storage
        async function loadData() {
            try {
                // Load patients
                const patientsResult = await window.storage.get('patients');
                patients = patientsResult && patientsResult.value ? JSON.parse(patientsResult.value) : [];
                
                // Load calls
                const callsResult = await window.storage.get('emergency-calls');
                calls = callsResult && callsResult.value ? JSON.parse(callsResult.value) : [];
                
                // Load EMTs
                const emtsResult = await window.storage.get('emt-units');
                if (emtsResult && emtsResult.value) {
                    emts = JSON.parse(emtsResult.value);
                } else {
                    // Initialize with sample EMTs
                    emts = [
                        { id: 'EMT-001', name: 'John Smith', unit: 'Unit A', status: 'available' },
                        { id: 'EMT-002', name: 'Sarah Johnson', unit: 'Unit B', status: 'available' },
                        { id: 'EMT-003', name: 'Mike Davis', unit: 'Unit C', status: 'busy' },
                        { id: 'EMT-004', name: 'Lisa Chen', unit: 'Unit D', status: 'available' },
                        { id: 'EMT-005', name: 'Tom Wilson', unit: 'Unit E', status: 'available' }
                    ];
                    await window.storage.set('emt-units', JSON.stringify(emts));
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Patient search
            document.getElementById('patientSearch').addEventListener('input', handlePatientSearch);
            
            // Form submission
            document.getElementById('emergencyCallForm').addEventListener('submit', handleFormSubmit);
            
            // Close search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.patient-search-section')) {
                    document.getElementById('searchResults').style.display = 'none';
                }
            });
        }
        
        // Handle patient search
        function handlePatientSearch(e) {
            const query = e.target.value.trim().toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            // Filter patients
            const filtered = patients.filter(p => 
                p.firstName.toLowerCase().includes(query) ||
                p.lastName.toLowerCase().includes(query) ||
                p.phoneNumber.includes(query) ||
                (p.patientId && p.patientId.toLowerCase().includes(query))
            );
            
            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 1rem; color: #94a3b8; text-align: center;">No patients found</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            // Display results
            resultsDiv.innerHTML = filtered.map(p => {
                const callCount = calls.filter(c => c.patientId === p.patientId).length;
                return `
                    <div class="search-result-item" onclick='selectPatient(${JSON.stringify(p)})'>
                        <div class="patient-name-result">${p.firstName} ${p.lastName}</div>
                        <div class="patient-details-result">
                            Phone: ${p.phoneNumber} | DOB: ${p.dateOfBirth || 'N/A'}
                            <span class="call-history-badge">${callCount} previous call(s)</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.style.display = 'block';
        }
        
        // Select patient from search
        function selectPatient(patient) {
            selectedPatient = patient;
            
            // Hide search results
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('patientSearch').value = '';
            
            // Show selected patient panel
            document.getElementById('selectedPatientPanel').style.display = 'block';
            document.getElementById('selectedPatientName').textContent = 
                `${patient.firstName} ${patient.lastName}`;
            document.getElementById('selectedPatientDetails').textContent = 
                `Phone: ${patient.phoneNumber} | DOB: ${patient.dateOfBirth || 'N/A'} | ID: ${patient.patientId}`;
            
            // Fill form with patient data
            document.getElementById('firstName').value = patient.firstName;
            document.getElementById('lastName').value = patient.lastName;
            document.getElementById('phoneNumber').value = patient.phoneNumber;
            document.getElementById('dateOfBirth').value = patient.dateOfBirth || '';
            
            // Load patient call history
            loadPatientCallHistory(patient.patientId);
        }
        
        // Clear patient selection
        function clearPatientSelection() {
            selectedPatient = null;
            document.getElementById('selectedPatientPanel').style.display = 'none';
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('dateOfBirth').value = '';
            document.getElementById('patientCallHistory').innerHTML = 
                '<p style="color: #94a3b8; text-align: center; padding: 2rem;">Select a patient to view call history</p>';
        }
        
        // Load patient call history
        function loadPatientCallHistory(patientId) {
            const patientCalls = calls.filter(c => c.patientId === patientId);
            const historyDiv = document.getElementById('patientCallHistory');
            
            if (patientCalls.length === 0) {
                historyDiv.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 2rem;">No previous calls for this patient</p>';
                return;
            }
            
            historyDiv.innerHTML = patientCalls.map(call => `
                <div class="call-history-item">
                    <div class="call-time">${formatDateTime(call.callTime)}</div>
                    <div class="call-description"><strong>Priority:</strong> ${call.priority}</div>
                    <div class="call-description">${call.incidentDescription}</div>
                    <div class="call-location">📍 ${call.address}, ${call.city}, ${call.state}</div>
                </div>
            `).join('');
        }
        
        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                phoneNumber: document.getElementById('phoneNumber').value.trim(),
                dateOfBirth: document.getElementById('dateOfBirth').value,
                callTime: document.getElementById('callTime').value,
                priority: document.getElementById('priority').value,
                address: document.getElementById('address').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: document.getElementById('state').value.trim(),
                incidentDescription: document.getElementById('incidentDescription').value.trim()
            };
            
            // Generate or use existing patient ID
            let patientId;
            if (selectedPatient) {
                patientId = selectedPatient.patientId;
            } else {
                // Create new patient
                patientId = 'P' + Date.now();
                const newPatient = {
                    patientId: patientId,
                    firstName: formData.firstName,
                    lastName: formData.lastName,
                    phoneNumber: formData.phoneNumber,
                    dateOfBirth: formData.dateOfBirth,
                    createdAt: new Date().toISOString()
                };
                patients.push(newPatient);
                await window.storage.set('patients', JSON.stringify(patients));
            }
            
            // Create call record
            const newCall = {
                callId: 'CALL' + Date.now(),
                patientId: patientId,
                ...formData,
                status: 'Active',
                operatorId: localStorage.getItem('username') || 'operator',
                createdAt: new Date().toISOString()
            };
            
            calls.push(newCall);
            await window.storage.set('emergency-calls', JSON.stringify(calls));
            
            // Show success notification
            showNotification('Emergency call submitted successfully!', 'success');
            
            // Reset form (except patient info if selected)
            document.getElementById('address').value = '';
            document.getElementById('city').value = '';
            document.getElementById('state').value = '';
            document.getElementById('incidentDescription').value = '';
            document.getElementById('priority').value = '';
            
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('callTime').value = localDateTime;
            
            if (selectedPatient) {
                loadPatientCallHistory(selectedPatient.patientId);
            } else {
                clearPatientSelection();
            }
            
            updateStats();
        }
        
        // Render EMT list
        function renderEMTList() {
            const emtListDiv = document.getElementById('emtList');
            
            emtListDiv.innerHTML = emts.map(emt => `
                <div class="emt-item ${emt.status}">
                    <div class="emt-info">
                        <div class="emt-name">${emt.name}</div>
                        <div class="emt-unit">${emt.unit} (${emt.id})</div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                        <span class="emt-status ${emt.status}">${emt.status}</span>
                        ${emt.status === 'available' ? 
                            `<button class="btn btn-primary" onclick="assignEMT('${emt.id}')">Assign</button>` : 
                            '<button class="btn btn-primary" disabled>Busy</button>'
                        }
                    </div>
                </div>
            `).join('');
        }
        
        // Assign EMT to call
        async function assignEMT(emtId) {
  // patched: write assignment into latest unassigned active call
  (async function(){
    try{
      const res = await window.storage.get('emergency-calls');
      const calls = res && res.value ? JSON.parse(res.value) : [];
      const emtRes = await window.storage.get('emt-units');
      const emts = emtRes && emtRes.value ? JSON.parse(emtRes.value) : [];
      const emt = emts.find(e => e.id === emtId) || emts.find(e => e.id === (typeof emtId!=='undefined'?emtId:null));
      const target = [...calls].reverse().find(c => c.status === 'Active' && !c.assignedEMTId);
      if (!target){ try{ showNotification && showNotification('배정할 활성 콜이 없습니다','error'); }catch(_){ alert('배정할 활성 콜이 없습니다'); } return; }
      if (emt){
        target.assignedEMTId = emt.id;
        target.assignedEMTName = emt.name || emt.id;
        target.status = 'In Progress';
        await window.storage.set('emergency-calls', JSON.stringify(calls));
        await window.storage.set('emt-units', JSON.stringify(emts));
        try{ renderEMTList && renderEMTList(); updateStats && updateStats(); }catch(_){}
        try{ showNotification && showNotification('배정 완료: ' + (emt.name || emt.id),'success'); }catch(_){ alert('배정 완료'); }
        localStorage.setItem('calls-updated', Date.now().toString());
      }
    }catch(err){ console.error(err); }
  })();

            if (calls.length === 0) {
                showNotification('No active calls to assign', 'error');
                return;
            }
            
            const emt = emts.find(e => e.id === emtId);
            if (!emt) return;
            
            if (confirm(`Assign ${emt.name} (${emt.unit}) to the most recent call?`)) {
                // Update EMT status
                emt.status = 'busy';
                await window.storage.set('emt-units', JSON.stringify(emts));
                
<script>
(async function(){
  const res = await window.storage.get('patients'); 
  window.patients = res && res.value ? JSON.parse(res.value) : [];
  const cres = await window.storage.get('emergency-calls');
  window.calls = cres && cres.value ? JSON.parse(cres.value) : [];

  function selectPatientByObj(p){
    try { if (typeof selectPatient === 'function') selectPatient(p); } catch(e){}
  }

  window.addEventListener('storage', async function(e){
    if (e.key !== 'incomingCall') return;
    var data = {};
    try { data = JSON.parse(e.newValue || '{}'); } catch(err){}
    if (!data || (!data.patientName && !data.phone && !data.address)) return;

    var parts = (data.patientName || '').trim().split(' ');
    var firstName = parts.shift() || '';
    var lastName = parts.join(' ');

    var phone = data.phone || '';
    var found = window.patients.find(p => phone && p.phoneNumber === phone);
    if (!found){
      found = { patientId: 'P'+Date.now(), firstName: firstName, lastName: lastName, phoneNumber: phone, dateOfBirth: '', createdAt: new Date().toISOString() };
      window.patients.push(found);
      await window.storage.set('patients', JSON.stringify(window.patients));
    }
    selectPatientByObj(found);

    var addrEl = document.getElementById('address');
    if (addrEl) addrEl.value = data.address || '';
    var descEl = document.getElementById('incidentDescription');
    if (descEl) descEl.value = data.description || '';
    var prioEl = document.getElementById('priority');
    if (prioEl) prioEl.value = 'High';
  }, false);
})();
</script>