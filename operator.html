<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Operator Dashboard - ERIS</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .dashboard-container {
            min-height: 100vh;
            padding: 2rem;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            color: #93c5fd;
            margin-bottom: 0.5rem;
        }
        
        .dashboard-subtitle {
            color: #cbd5e1;
            font-size: 1.1rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .card-title {
            font-size: 1.5rem;
            color: #e2e8f0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .call-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .call-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3b82f6;
        }
        
        .call-item.emergency {
            border-left-color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
        }
        
        .call-time {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .call-location {
            color: #e2e8f0;
            font-weight: 500;
            margin: 0.5rem 0;
        }
        
        .call-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-completed {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #93c5fd;
        }
        
        .stat-label {
            color: #cbd5e1;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .back-button {
            position: absolute;
            top: 2rem;
            left: 2rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .incoming-call-banner {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border: 2px solid rgba(220, 38, 38, 0.5);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
            animation: slideDown 0.3s ease-out;
        }
        
        .banner-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .banner-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .record-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            color: #e2e8f0;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .form-group select option {
            background: #1e3c72;
            color: white;
        }
        
        .patient-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #3b82f6;
        }
        
        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .patient-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .record-count {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .record-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid #10b981;
            position: relative;
        }
        
        .record-content {
            padding-right: 8rem;
        }
        
        .record-time {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .record-address {
            color: #e2e8f0;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .record-incident {
            color: #cbd5e1;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }
        
        .record-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-direction: column;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-delete:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        .no-records {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
            padding: 2rem;
        }
        
        .success-toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .banner-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .banner-buttons {
                justify-content: center;
            }
            
            .record-content {
                padding-right: 0;
                margin-bottom: 3rem;
            }
            
            .record-actions {
                position: static;
                flex-direction: row;
                margin-top: 1rem;
            }
        }
    </style>
<script>
window.storage = window.storage || {
  get: async function(k){ return { value: localStorage.getItem(k) }; },
  set: async function(k,v){ localStorage.setItem(k,v); }
};
</script>
</head>
<body>
    <a href="index.html" class="back-button">← Back to Home</a>
    
    <div class="dashboard-container">
        <div id="incomingCallBanner" class="incoming-call-banner" style="display: none;" role="alert">
            <div class="banner-content">
                <span id="bannerMessage">Incoming Call from </span>
                <div class="banner-buttons">
                    <button class="btn btn-primary" onclick="fillFormFromIncomingCall()">Fill Form</button>
                    <button class="btn btn-danger" onclick="dismissBanner()">Dismiss</button>
                </div>
            </div>
        </div>
        
        <div class="dashboard-header">
            <h1 class="dashboard-title">Call Operator Dashboard</h1>
            <p class="dashboard-subtitle">Manage emergency calls and dispatch resources</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCalls">0</div>
                <div class="stat-label">Total Calls Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeCalls">0</div>
                <div class="stat-label">Active Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgResponse">5.2</div>
                <div class="stat-label">Avg Response (min)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="resolvedCalls">0</div>
                <div class="stat-label">Resolved</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h2 class="card-title">📞 Active Calls</h2>
                <div class="call-list" id="activeCallsList">
                    <div class="no-records">Loading...</div>
                </div>
            </div>
            
            <div class="dashboard-card">
                <h2 class="card-title">🚑 Available Resources</h2>
                <div id="resourcesList">
                    <div class="no-records">Loading...</div>
                </div>
            </div>
            
            <div class="dashboard-card">
                <h2 class="card-title">📊 Recent Activity</h2>
                <div class="call-list" id="recentActivityList">
                    <div class="no-records">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="dashboard-card">
            <h2 class="card-title">📝 New Emergency Call Record</h2>
            <form id="newRecordForm" class="record-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="callerPhone">Phone Number *</label>
                        <input type="tel" id="callerPhone" name="callerPhone" required placeholder="e.g., 555-123-4567">
                    </div>
                    <div class="form-group">
                        <label for="recordTime">Call Time *</label>
                        <input type="datetime-local" id="recordTime" name="recordTime" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="priority">Priority *</label>
                        <select id="priority" name="priority" required>
                            <option value="">Select Priority</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="state">State *</label>
                        <input type="text" id="state" name="state" required placeholder="e.g., IN">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="street">Street Address *</label>
                        <input type="text" id="street" name="street" required placeholder="e.g., 123 Main St">
                    </div>
                    <div class="form-group">
                        <label for="apt">Apt/Suite (Optional)</label>
                        <input type="text" id="apt" name="apt" placeholder="e.g., Apt 4B">
                    </div>
                </div>
                <div class="form-group">
                    <label for="incidentDescription">Incident Description *</label>
                    <textarea id="incidentDescription" name="incidentDescription" rows="3" required placeholder="Describe the emergency situation..."></textarea>
                </div>
                <button type="submit" class="btn btn-success">💾 Save Call Record</button>
            </form>
        </div>
        
        <div class="dashboard-card">
            <h2 class="card-title">📋 Patient Call History (Grouped by Patient)</h2>
            <div id="patientRecordsContainer">
                <div class="no-records" id="noRecordsMessage">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        let incomingCallData = null;
        const KEY_PATIENTS = 'patients';
        const KEY_CALLS = 'emergency-calls';
        const KEY_EMTS = 'emt-units';

        async function loadJSON(key, fallback){
          try{
            const res = await window.storage.get(key);
            return res && res.value ? JSON.parse(res.value) : (fallback || []);
          }catch(_){ return fallback || []; }
        }
        
        async function saveJSON(key, value){
          await window.storage.set(key, JSON.stringify(value));
        }

        let selectedCallId = null;
        
        // 샘플 데이터 초기화
        async function initializeSampleData() {
            let calls = await loadJSON(KEY_CALLS, []);
            let patients = await loadJSON(KEY_PATIENTS, []);
            let emts = await loadJSON(KEY_EMTS, []);
            
            if (patients.length === 0) {
                patients = [
                    { patientId: 'P1001', firstName: 'John', lastName: 'Smith', phoneNumber: '555-123-4567', createdAt: new Date().toISOString() },
                    { patientId: 'P1002', firstName: 'Sarah', lastName: 'Johnson', phoneNumber: '555-234-5678', createdAt: new Date().toISOString() },
                    { patientId: 'P1003', firstName: 'Michael', lastName: 'Davis', phoneNumber: '555-345-6789', createdAt: new Date().toISOString() }
                ];
                await saveJSON(KEY_PATIENTS, patients);
            }
            
            if (calls.length === 0) {
                const now = new Date();
                calls = [
                    {
                        callId: 'C1001',
                        patientId: 'P1001',
                        patientName: 'John Smith',
                        phone: '555-123-4567',
                        address: '123 Main St, Lafayette, IN',
                        street: '123 Main St', apt: '', state: 'IN',
                        description: 'Severe chest pain, difficulty breathing',
                        priority: 'High',
                        createdAt: new Date(now.getTime() - 10 * 60000).toISOString(),
                        status: 'Active',
                        assignedEMTId: null,
                        assignedEMTName: null
                    },
                    {
                        callId: 'C1002',
                        patientId: 'P1002',
                        patientName: 'Sarah Johnson',
                        phone: '555-234-5678',
                        address: '456 Oak Ave, Apt 2B, Lafayette, IN',
                        street: '456 Oak Ave', apt: 'Apt 2B', state: 'IN',
                        description: 'Fall injury, possible broken ankle',
                        priority: 'Medium',
                        createdAt: new Date(now.getTime() - 25 * 60000).toISOString(),
                        status: 'In Progress',
                        assignedEMTId: 'EMT-001',
                        assignedEMTName: 'EMT Unit 1'
                    },
                    {
                        callId: 'C1003',
                        patientId: 'P1001',
                        patientName: 'John Smith',
                        phone: '555-123-4567',
                        address: '123 Main St, Lafayette, IN',
                        street: '123 Main St', apt: '', state: 'IN',
                        description: 'Previous heart attack, follow-up',
                        priority: 'High',
                        createdAt: new Date(now.getTime() - 2 * 60 * 60000).toISOString(),
                        status: 'Completed',
                        assignedEMTId: 'EMT-002',
                        assignedEMTName: 'EMT Unit 2'
                    },
                    {
                        callId: 'C1004',
                        patientId: 'P1003',
                        patientName: 'Michael Davis',
                        phone: '555-345-6789',
                        address: '789 Pine Dr, Lafayette, IN',
                        street: '789 Pine Dr', apt: '', state: 'IN',
                        description: 'Allergic reaction to medication',
                        priority: 'High',
                        createdAt: new Date(now.getTime() - 5 * 60000).toISOString(),
                        status: 'Active',
                        assignedEMTId: null,
                        assignedEMTName: null
                    }
                ];
                await saveJSON(KEY_CALLS, calls);
            }
            
            if (emts.length === 0) {
                emts = [
                    { id: 'EMT-001', name: 'EMT Unit 1', status: 'on-call', station: 'Station A' },
                    { id: 'EMT-002', name: 'EMT Unit 2', status: 'available', station: 'Station B' },
                    { id: 'EMT-003', name: 'EMT Unit 3', status: 'available', station: 'Station C' }
                ];
                await saveJSON(KEY_EMTS, emts);
            }
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('recordTime').value = localDateTime;
            
            checkForIncomingCall();
            await initializeSampleData();
            await renderActiveCalls();
            await renderEMTList();
            await renderGroupedRecords();
            await renderRecentActivity();
            await updateStats();
            
            document.getElementById('newRecordForm').addEventListener('submit', handleFormSubmit);
            window.addEventListener('storage', handleStorageEvent);
        });
        
        function checkForIncomingCall() {
            const incomingCall = localStorage.getItem('incomingCall');
            if (incomingCall) {
                incomingCallData = JSON.parse(incomingCall);
                showIncomingCallBanner();
            }
        }
        
        async function handleStorageEvent(event) {
            if (event.key === 'incomingCall') {
                if (event.newValue) {
                    incomingCallData = JSON.parse(event.newValue);
                    showIncomingCallBanner();
                } else {
                    incomingCallData = null;
                    hideIncomingCallBanner();
                }
            }
            if ([KEY_CALLS, KEY_EMTS].includes(event.key)){
                await renderActiveCalls();
                await renderEMTList();
                await updateStats();
            }
        }
        
        function showIncomingCallBanner() {
            if (incomingCallData) {
                document.getElementById('bannerMessage').textContent = `Incoming Call from ${incomingCallData.patientName}`;
                document.getElementById('incomingCallBanner').style.display = 'block';
            }
        }
        
        function hideIncomingCallBanner() {
            document.getElementById('incomingCallBanner').style.display = 'none';
        }
        
        function fillFormFromIncomingCall() {
            if (incomingCallData) {
                const nameParts = incomingCallData.patientName.split(' ');
                document.getElementById('firstName').value = nameParts[0] || '';
                document.getElementById('lastName').value = nameParts.slice(1).join(' ') || '';
                
                if (incomingCallData.phone) document.getElementById('callerPhone').value = incomingCallData.phone;
                
                const addressParts = incomingCallData.address.split(',');
                document.getElementById('street').value = addressParts[0]?.trim() || incomingCallData.address;
                document.getElementById('state').value = addressParts[addressParts.length - 1]?.trim() || '';
                document.getElementById('incidentDescription').value = incomingCallData.description;
                
                const now = new Date();
                document.getElementById('recordTime').value = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                
                localStorage.removeItem('incomingCall');
                incomingCallData = null;
                hideIncomingCallBanner();
                document.getElementById('firstName').focus();
            }
        }
        
        function dismissBanner() {
            localStorage.removeItem('incomingCall');
            incomingCallData = null;
            hideIncomingCallBanner();
        }
        
        async function handleFormSubmit(event){
          event.preventDefault();
          const fd = new FormData(event.target);
          const firstName = fd.get('firstName').trim();
          const lastName = fd.get('lastName').trim();
          const callerPhone = fd.get('callerPhone').trim();
          const street = fd.get('street').trim();
          const apt = (fd.get('apt') || '').trim();
          const state = fd.get('state').trim();
          const incident = fd.get('incidentDescription').trim();
          const priority = fd.get('priority').trim();
          const recordTimeISO = fd.get('recordTime');

          if (!firstName || !lastName || !callerPhone || !street || !state || !incident || !priority){
            alert('Please fill in all required fields.'); return;
          }

          let patients = await loadJSON(KEY_PATIENTS, []);
          let patient = patients.find(p => p.phoneNumber === callerPhone);
          if (!patient){
            patient = {
              patientId: 'P' + Date.now(),
              firstName, lastName,
              phoneNumber: callerPhone,
              createdAt: new Date().toISOString()
            };
            patients.push(patient);
          } else {
            patient.firstName = firstName;
            patient.lastName = lastName;
          }
          await saveJSON(KEY_PATIENTS, patients);

          let calls = await loadJSON(KEY_CALLS, []);
          calls.push({
            callId: 'C' + Date.now(),
            patientId: patient.patientId,
            patientName: `${firstName} ${lastName}`,
            phone: callerPhone,
            address: apt ? `${street}, ${apt}, ${state}` : `${street}, ${state}`,
            street, apt, state,
            description: incident,
            priority,
            createdAt: recordTimeISO || new Date().toISOString(),
            status: 'Active',
            assignedEMTId: null,
            assignedEMTName: null
          });
          await saveJSON(KEY_CALLS, calls);

          showToast('✅ Call record saved successfully!');
          await Promise.all([renderActiveCalls(), renderGroupedRecords(), renderRecentActivity(), updateStats()]);
          
          event.target.reset();
          const now = new Date();
          document.getElementById('recordTime').value = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        }
        
        async function renderActiveCalls(){
          const list = document.getElementById('activeCallsList');
          const calls = await loadJSON(KEY_CALLS, []);
          const active = calls.filter(c => c.status === 'Active' || c.status === 'In Progress')
                              .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
          
          if (active.length === 0){
            list.innerHTML = '<div class="no-records">No active calls.</div>';
            return;
          }
          
          list.innerHTML = active.map(c => {
            const statusClass = c.status === 'Active' ? 'status-pending' : 'status-active';
            const priorityClass = c.priority && c.priority.toLowerCase() === 'high' ? 'emergency' : '';
            return `
              <div class="call-item ${priorityClass}">
                <div class="call-time">${new Date(c.createdAt).toLocaleString()}</div>
                <div class="call-location"><strong>${c.patientName}</strong></div>
                <div style="color: #cbd5e1; font-size: 0.9rem;">📞 ${c.phone}</div>
                <div style="color: #cbd5e1; font-size: 0.9rem;">📍 ${c.address}</div>
                <div style="color: #cbd5e1; font-size: 0.9rem; margin-top: 0.5rem;">${c.description}</div>
                <div style="margin-top: 0.5rem;">
                  <span class="call-status ${statusClass}">${c.status}</span>
                  <span style="margin-left: 0.5rem; color: ${c.priority === 'High' ? '#ef4444' : c.priority === 'Medium' ? '#f59e0b' : '#10b981'}; font-weight: 600;">Priority: ${c.priority}</span>
                </div>
                ${c.assignedEMTName ? `<div style="color: #10b981; font-size: 0.9rem; margin-top: 0.5rem;">🚑 Assigned to: ${c.assignedEMTName}</div>` : ''}
                <div class="action-buttons">
                  <button class="btn btn-primary" onclick="selectCall('${c.callId}')">Select Call</button>
                  <button class="btn btn-success" onclick="promptAssign('${c.callId}')">${c.assignedEMTName ? 'Reassign EMT' : 'Dispatch EMT'}</button>
                </div>
              </div>
            `;
          }).join('');
        }
        
        function selectCall(callId){
          selectedCallId = callId;
          showToast('✅ Call selected! Now click "Assign" on an available EMT unit.');
        }
        
        async function renderEMTList(){
          let emts = await loadJSON(KEY_EMTS, []);
          const list = document.getElementById('resourcesList');
          list.innerHTML = emts.map(e => {
            const statusClass = e.status === 'available' ? 'status-active' : 'status-pending';
            const statusText = e.status === 'available' ? 'Available' : 'On Call';
            return `
              <div class="call-item">
                <div class="call-location"><strong>${e.name}</strong></div>
                <div style="color: #cbd5e1; font-size: 0.9rem;">📍 ${e.station}</div>
                <span class="call-status ${statusClass}">${statusText}</span>
                ${e.status === 'available' ? `
                  <div class="action-buttons">
                    <button class="btn btn-success" onclick="assignSelectedTo('${e.id}')">Assign to Selected</button>
                  </div>
                ` : ''}
              </div>
            `;
          }).join('');
        }
        
        async function promptAssign(callId){
          selectedCallId = callId;
          showToast('Call selected. Now click "Assign to Selected" on an available EMT.');
        }
        
        async function assignSelectedTo(emtId){
          if (!selectedCallId){ alert('Select a call first.'); return; }
          let calls = await loadJSON(KEY_CALLS, []);
          let emts = await loadJSON(KEY_EMTS, []);
          const call = calls.find(c => c.callId === selectedCallId);
          const emt = emts.find(e => e.id === emtId);
          if (!call || !emt){ alert('Not found'); return; }
          if (emt.status !== 'available'){ alert('Selected EMT is not available.'); return; }

          call.assignedEMTId = emt.id;
          call.assignedEMTName = emt.name;
          call.status = 'In Progress';
          emt.status = 'on-call';

          await saveJSON(KEY_CALLS, calls);
          await saveJSON(KEY_EMTS, emts);
          selectedCallId = null;
          await renderActiveCalls();
          await renderEMTList();
          showToast('✅ EMT dispatched to the call successfully!');
        }
        
        async function renderGroupedRecords(){
          const container = document.getElementById('patientRecordsContainer');
          const noRecordsMessage = document.getElementById('noRecordsMessage');
          const calls = await loadJSON(KEY_CALLS, []);
          if (!calls || calls.length === 0){
            noRecordsMessage.style.display = 'block';
            container.innerHTML = '';
            return;
          }
          noRecordsMessage.style.display = 'none';

          const groups = {};
          calls.forEach(c => {
            const key = c.patientId || c.patientName || 'Unknown';
            (groups[key] = groups[key] || {name: c.patientName, items: []}).items.push(c);
          });
          Object.values(groups).forEach(g => g.items.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt)));

          let html = '';
          for (const gkey of Object.keys(groups)){
            const g = groups[gkey];
            html += `
              <div class="patient-group">
                <div class="patient-header">
                  <div class="patient-name">${g.name}</div>
                  <div class="record-count">${g.items.length} record${g.items.length !== 1 ? 's' : ''}</div>
                </div>
                ${g.items.map(record => `
                  <div class="record-item">
                    <div class="record-content">
                      <div class="record-time">${new Date(record.createdAt).toLocaleString()}</div>
                      <div class="record-address">📍 ${record.address}</div>
                      <div class="record-incident">${record.description}</div>
                      <div class="record-incident">Priority: <span style="color: ${record.priority === 'High' ? '#ef4444' : record.priority === 'Medium' ? '#f59e0b' : '#10b981'};">${record.priority}</span></div>
                      <div class="record-incident">Status: ${record.status}</div>
                      ${record.assignedEMTName ? `<div class="record-incident" style="color: #10b981;">🚑 ${record.assignedEMTName}</div>` : ''}
                    </div>
                    <div class="record-actions">
                      <button class="btn-delete" onclick="deleteCall('${record.callId}')">🗑️</button>
                      <button class="btn btn-primary" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;" onclick="promptAssign('${record.callId}')">${record.assignedEMTName ? 'Reassign' : 'Assign EMT'}</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `;
          }
          container.innerHTML = html;
        }
        
        async function deleteCall(callId){
          if (!confirm('Delete this record?')) return;
          let calls = await loadJSON(KEY_CALLS, []);
          calls = calls.filter(c => c.callId !== callId);
          await saveJSON(KEY_CALLS, calls);
          await renderActiveCalls();
          await renderGroupedRecords();
          await renderRecentActivity();
          await updateStats();
          showToast('Record deleted successfully.');
        }
        
        async function renderRecentActivity(){
          const list = document.getElementById('recentActivityList');
          const calls = await loadJSON(KEY_CALLS, []);
          const completed = calls.filter(c => c.status === 'Completed')
                                 .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt))
                                 .slice(0, 5);
          
          if (completed.length === 0){
            list.innerHTML = '<div class="no-records">No recent activity.</div>';
            return;
          }
          
          list.innerHTML = completed.map(c => `
            <div class="call-item">
              <div class="call-time">${new Date(c.createdAt).toLocaleString()}</div>
              <div class="call-location">${c.patientName} - ${c.address}</div>
              <div style="color: #cbd5e1; font-size: 0.9rem;">${c.description}</div>
              <span class="call-status status-completed">Resolved</span>
            </div>
          `).join('');
        }
        
        async function updateStats() {
          const calls = await loadJSON(KEY_CALLS, []);
          const today = new Date().toDateString();
          const todayCalls = calls.filter(c => new Date(c.createdAt).toDateString() === today);
          
          document.getElementById('totalCalls').textContent = todayCalls.length;
          document.getElementById('activeCalls').textContent = calls.filter(c => c.status === 'Active').length;
          document.getElementById('resolvedCalls').textContent = calls.filter(c => c.status === 'Completed').length;
        }
        
        function showToast(message) {
          const existingToast = document.querySelector('.success-toast');
          if (existingToast) existingToast.remove();
          
          const toast = document.createElement('div');
          toast.className = 'success-toast';
          toast.textContent = message;
          toast.setAttribute('role', 'alert');
          document.body.appendChild(toast);
          
          setTimeout(() => { if (toast.parentNode) toast.remove(); }, 3000);
        }
    </script>
</body>
</html>